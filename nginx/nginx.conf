events {
    worker_connections 1024;
}

http {

    resolver 127.0.0.11 valid=5s;
    upstream frontend  { server frontend:5000;
     }
    upstream user_svc  { server user-service:8001;
     }
    upstream search_svc{ server search-service:8003;
     }
    # you’ll need dynamic resolution or DNS entries for each user’s transcriber service:
    # e.g. user “42” → host “42-transcriber”

    server {
        listen 80;

        # UI
        location / {
            proxy_pass http://frontend;
        }

        # User & Conversation APIs
        location /api/users/ {
            proxy_pass http://user_svc/api/users/;
        }
        location /api/conversations/ {
            proxy_pass http://user_svc/api/conversations/;
        }

        # Search
        location /api/search/ {
            proxy_pass http://search_svc/api/search/;
        }

        # Per-user transcription
        location ~ ^/api/transcribe/([^/]+)/(.+)$ {
            set $uid  $1;
            set $rest $2;
            proxy_pass http://$uid-transcriber:8002/api/transcribe/$rest;
        }
    }
}




# upstream frontend {
#     server frontend:8000;
# }

# upstream transcriber {
#     server transcriber:8000;
# }

# upstream search {
#     server search:8000;
# }

# upstream user_service {
#     server user-service:8000;
# }

# server {
#     listen 80;
#     server_name localhost;

#     location / {
#         proxy_pass http://frontend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }

#     location /api/transcribe {
#         proxy_pass http://transcriber;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }

#     location /api/search {
#         proxy_pass http://search;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#     }

#     location /api/users {
#         proxy_pass http://user_service;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header Content-Type application/json;
#     }

#     location /api/conversations {
#         proxy_pass http://user_service;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header Content-Type application/json;
#     }

#     location ~ ^/api/conversations/(?<name>[^/]+)/join$ {
#         proxy_pass http://user_service/conversations/$name/join;
#     }
# }
